# Генерация изображений окружающего пространства по спутниковым снимкам

В общем виде задача, решаемая в работе, звучит так: «интерпретировать спутниковый снимок и предсказать что увидит наблюдатель, оказавшись в этой точке Земли».
В качестве исходной информации для генерации изображения окружающей среды выступает только спутниковый снимок (ну и, соответственно, веса обученных нейронных сетей).

На визуальном языке моделей машинного обучения искомое решение проблемы можно представить так:

<br/><div align="center" >
  <img alt="Схема решения" src="./assets/generating.png" width="600px" />
</div><br/>

В его основе две нейронных сети: энкодер и генератор.

1. Энкодер выделяет из спутникового изображения полезные признаки и отображает их в скрытое пространство низкой размерности
2. Генератор умеет создавать изображения-снимки местности, основываясь на входном состоянии — точке в скрытом пространстве

Вспомогательным звеном выступает дискриминатор, необходмый в процессе обучения генератора, но не используеющийся в последствии. 

## Условия и ограничения

Эта работа, как учебный проект, имеет ряд серьезных ограничений, как выявленных в процессе реализации, так и принятых в самом начале:

1. Генерируемые изображения имеют размер 128 на 128 пикселей
2. Фотографии, используемые для обучения генератора, содержат лишь несколько видов летнего ландшафта средней полосы
3. Энкодер обучается на участках спутниковых снимков размером 128 на 128 пикселей

Причиной таких ограничений явились два момента:

1. Ограниченность вычислительных ресурсов
2. Нетривиальность сбора данных для обучения

## Сбор и анализ данных

Для обучения нейронных сетей потребовалось два набора изображений:
 
1. Пейзажные фотографии с привязкой к географическим координатам места получения снимка
2. Спутниковые снимки поверхности Земли в соответствующих точках

Получить их позволяют публичные API Яндекс Карт и VK.

### Сбор пейзажных снимков

Для формирования датасета фотографий с геопривязками использовался API VK для доступа к общедоступным фотографиям. Кроме непосредственного скачивания фотографий потребовался многостадийный процесс их фильтрации, чтобы оставить ограниченный набор сцен для обучения генератора. В общем виде последовательный процесс получения итогового набора изображений следующий:

1. Получение списка публичных фотографий, загруженных пользователями
2. Отсеивание изображений, не имеющих привязки к географическим координатам
3. Фильтрация изображений согласно списку классов (используя нейросеть, предобученную на датасете Places365)
4. Фильтрация изображений, содержащих фигуры и лица людей (также используя предобученную стороннюю нейросеть)
5. Ручной отбор неподходящих снимков, пропущенных предыдущими фильтрами

В итоге из около полумиллиона загруженных фотографий были отобраны около 3000 фотографий для датасета. Это визуально приятные фотографии природы средней полосы России (Московская и Ярославская области) в теплое время года и при хорошей погоде днем. 

> В начале была предпринята попытка включить в набор даных также виды населенных пунктов, но процесс обучения генератора показал, что в этом случае фотографий должно быть значительно больше, для достижения мало-мальски воспринимаемого результата

Код описанного пути представлен в блокнотах [download_images.ipynb](./download_images.ipynb) и [filter_images.ipynb](./filter_images.ipynb).

### Сбор спутниковых снимков

Здесь задача оказалась значительно проще. Для географических координат каждой фотографии из пункта выше был получен спутниковый снимок с помощью Static API Яндекс Карт.

Код представлен в блокноте: [download_satellite_images.ipynb](./download_satellite_images.ipynb).

В итоге были получены два набора фотографий следующего вида:

<br/><div align="center" >
  <img alt="Примеры" src="./assets/datasets_examples.png" width="950px" />
</div><br/>

## Реализация

Процесс обучения итоговой пары моделей можно разбить на два этапа:

1. Обучение генеративно-состязательной сети для создания фотографий из состояний скрытого пространства
2. Обучение сети энкодера, преобразующего призначи спутникового снимка в состояние скрытого пространства

Первый этап не зависит от второго, его итогом является модель-генератор, создающая изображния схожие представленным в датасете. На втором этапе, имея уже работающий генератор, энкодер обучается заставлять его генерировать пейзажи схожие исходным, в точках, где вторые были сняты.

<br/><div align="center" >
  <img alt="Архитектура генератора и энкодера" src="./assets/training.png" width="800px" />
</div><br/>

Далее подробно по каждому из этапов. 

### Архитектура и обучение генератора 

Так как набор сцен и состояний сильно ограничен, оказалось, что двузначная, а тем боле трехзначная, размерность скрытого пространства избыточна (сеть долго обучается и склонна к переобучению), поэтому было решено остановиться на 4-мерном векторе. Далее последовательное применение 5 слоев, использующих двумерные транспонированные свертки размером 4 на 4 с шагом 2. 

<br/><div align="center" >
  <img alt="Архитектура генератора" src="./assets/generator.png" width="500px" />
</div><br/>

На выходе получае цветное трехканальное квадратное изображение размером 128 на 128 пикселей. В силу того, вариантивность обучающих сцен достаточно небольшая, сеть обучалась с нуля, а не использовался fine tuning предобученного генератора.

Дискриминатор в свою очередь является практически зеркальным отражением генератора. Поступающее на вход изображение сквозь последовательные сверточные слои приводится к скалярной величине от 0 до 1, соответствующей вероятности того, что это изображение является сгенерированным нейросетью.


<br/><div align="center" >
  <img alt="Архитектура дискриминатора" src="./assets/discriminator.png" width="500px" />
</div><br/>


В отличие от сети дескриминатора, который оставался достаточно точным при любом достигнутом числе итераций, генератор, по визуальной оценке, достигал максимального качества и начинал трансформировать уже, кажется, хорошо сформировавшиеся карты признаков. Поэтому шаг обучения генератора дополнительно корректировался шедулером StepLR, чтобы не промахваться мимо локальных минимумов. При использовавшихся шагах обучения, и наборе данных, своего потолка сеть достигает примерно на 800 эпохе.

<br/><div align="center" >
  <img alt="Результаты работы генератора" src="./assets/gan_results.png" width="500px" />
</div><br/>

Код представлен в блокноте: [gan.ipynb](./gan.ipynb).

### Архитектура и обучение энкодера

#### Выбор функции потерь

| MSE Loss | <img src="./assets/loss_samples/real1.png" width="80" height="80"> | <img src="./assets/loss_samples/real2.png" width="80" height="80"> | <img src="./assets/loss_samples/real3.png" width="80" height="80"> |
| - | :-: | :-: | :-: |
| <img src="./assets/loss_samples/gen1.png" width="80" height="80"> | **0.14** | 0.46 | 0.22 |
| <img src="./assets/loss_samples/gen2.png" width="80" height="80"> | 0.40 | 0.43 | **0.30** |
| <img src="./assets/loss_samples/gen3.png" width="80" height="80"> | 0.61 | 0.27 | **0.22** |

| SSIM Loss | <img src="./assets/loss_samples/real1.png" width="80" height="80"> | <img src="./assets/loss_samples/real2.png" width="80" height="80"> | <img src="./assets/loss_samples/real3.png" width="80" height="80"> |
| - | :-: | :-: | :-: |
| <img src="./assets/loss_samples/gen1.png" width="80" height="80"> | **0.84** | 0.96 | 0.96 |
| <img src="./assets/loss_samples/gen2.png" width="80" height="80"> | **0.90** | **0.90** | 0.94 |
| <img src="./assets/loss_samples/gen3.png" width="80" height="80"> | 1.05 | **0.89** | 0.92 |

| Custom<br/> Loss | <img src="./assets/loss_samples/real1.png" width="80" height="80"> | <img src="./assets/loss_samples/real2.png" width="80" height="80"> | <img src="./assets/loss_samples/real3.png" width="80" height="80"> |
| - | :-: | :-: | :-: |
| <img src="./assets/loss_samples/gen1.png" width="80" height="80"> | **3.40** | 4.23 | 4.37 |
| <img src="./assets/loss_samples/gen2.png" width="80" height="80"> | 6.79 | **4.08** | 4.61 |
| <img src="./assets/loss_samples/gen3.png" width="80" height="80"> | 5.67 | 3.16 | **2.66** |

<br/><div align="center" >
  <img alt="Архитектура энкодера" src="./assets/encoder.png" width="500px" />
</div><br/>

## Результаты
![Демонстрация работы сети](./demo/prediction.gif)
